<html>
  <head>
    <script
      id="fsc-api"
      src="https://d1f8f9xcsvx3ha.cloudfront.net/sbl/0.8.5/fastspring-builder.min.js"
      type="text/javascript"
      data-storefront="simplify.test.onfastspring.com/popup-simplify"
      data-data-callback="dataCallbackFunction"
      data-popup-closed="onPopupClose"
      data-error-callback="errorCallback"
      data-popup-webhook-received="popupWebhookReceived"
      data-debug="false"
    ></script>
    <!-- Documentation: https://fastspring.com/docs/get-started-with-store-builder-library/
      data-before-requests-callback="beforeRequestsCallbackFunction"
      data-after-requests-callback="afterRequestsCallbackFunction"
      data-before-markup-callback="beforeMarkupCallbackFunction"
      data-after-markup-callback="afterMarkupCallbackFunction"
      data-decorate-callback="decorateURLFunction"
      data-popup-event-received="popupEventReceived"
      data-access-key=".. access key .."
      data-continuous="true"
    -->
    <style>
      body {
        padding: 100px;
        line-height: 1.7em;
        font-size: 16px;
      }
      li {
        padding-bottom: 0.7em;
      }
      .annual .monthly,
      .monthly .annual {
        display: none;
      }

      #simplify div {
        margin: 10px;
        padding: 5px 10px;
      }
      #simplify input {
        padding: 5px;
      }
      #simplify button {
        margin: 10px 20px;
        padding: 5px 10px;
      }
    </style>
  </head>
  <body>
    <!-- <ul>
      <li>
        Individual:
        <a
          href="#"
          data-fsc-action="Reset,Add,Checkout"
          data-fsc-item-path-value="simplify-gmail-annual"
          onmousedown="updateSession('simplify-gmail-annual', 1)"
          >Annual ($24)</a
        >
        |
        <a
          href="#"
          data-fsc-action="Reset,Add,Checkout"
          data-fsc-item-path-value="simplify-gmail-monthly"
          onmousedown="updateSession('simplify-gmail-monthly', 1)"
          >Monthly ($3)</a
        >
      </li>
      <li>
        Group of 2:
        <a
          href="#"
          data-fsc-action="Reset,Add,Checkout"
          data-fsc-item-path-value="simplify-gmail-annual"
          onmousedown="updateSession('simplify-gmail-annual', 2)"
          >Annual ($36)</a
        >
        |
        <a
          href="#"
          data-fsc-action="Reset,Add,Checkout"
          data-fsc-item-path-value="simplify-gmail-monthly"
          onmousedown="updateSession('simplify-gmail-monthly', 2)"
          >Monthly ($4)</a
        >
      </li>
    </ul> -->

    <div id="simplify">
      <b>Pricing v1.14</b> - In testing. Not for real use.

      <div id="plan" class="annual">
        <span class="annual"
          ><b>Annual</b> |
          <a href="#" onclick="updatePlan('monthly')">Monthly</a></span
        >
        <span class="monthly"
          ><a href="#" onclick="updatePlan('annual')">Annual</a> |
          <b>Monthly</b></span
        >
      </div>
      <div id="quantity">
        <input
          type="number"
          id="quantity-value"
          min="1"
          max="20"
          step="1"
          value="1"
          data-fsc-item-quantity-value
          onchange="updateQty()"
        />
      </div>
      <button
        id="checkoutButton"
        data-fsc-item-quantity
        data-fsc-action="Reset,Add,Checkout"
        data-fsc-item-path-value="simplify-gmail-annual"
      >
        Checkout
      </button>
    </div>
  </body>

  <script>
    // UTILITIES
    const get = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelector(selector);
      } else {
        return parent.querySelector(selector);
      }
    };

    const gets = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelectorAll(selector);
      } else {
        return parent.querySelectorAll(selector);
      }
    };

    const count = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelectorAll(selector).length;
      } else {
        return parent.querySelectorAll(selector).length;
      }
    };

    // FASTSPRING UTILS
    function dataCallbackFunction(order) {
      console.log("[Simplify] Order data retrieved", order);
    }
    function errorCallback(code, string) {
      console.log("[Simplify] Error: ", code, string);
    }
    function onPopupClose(order) {
      if (order === null) {
        console.log("[Simplify] Popup closed: Order failed", order);
      } else {
        console.log("[Simplify] Popup closed: Order succeeded?", order);
      }
    }
    function popupWebhookReceived(order) {
      console.log("[Simplify] Order received?", order);
    }

    function setCustomer() {
      // Re-init customer data
      fastspring.builder.recognize({
        email: "hi.simplify@gmail.com",
        firstName: "Michael",
        lastName: "Leggett",
      });
    }

    let currentPlan = "simplify-gmail-annual";
    let currentQty = 1;
    let planEl = get("#plan");

    function updateQty() {
      currentQty = get("#quantity-value").value;
      get("#quantity-value").setAttribute("value", currentQty);
      console.log("Quantiy updated", currentQty);
      fastspring.builder.update(currentPlan, currentQty);
    }

    function updatePlan(newPlan) {
      if (newPlan === "annual") {
        planEl.classList.remove("monthly");
        planEl.classList.add("annual");
        currentPlan = "simplify-gmail-annual";
        get("#checkoutButton").dataset.fscItemPathValue = currentPlan;
        fastspring.builder.update(currentPlan, currentQty);
      } else if (newPlan === "monthly") {
        planEl.classList.remove("annual");
        planEl.classList.add("monthly");
        currentPlan = "simplify-gmail-monthly";
        get("#checkoutButton").dataset.fscItemPathValue = currentPlan;
        fastspring.builder.update(currentPlan, currentQty);
      }
    }
  </script>
</html>
