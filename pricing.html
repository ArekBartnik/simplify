<html>
  <head>
    <script
      src="https://d1f8f9xcsvx3ha.cloudfront.net/sbl/0.8.5/fastspring-builder.min.js"
      id="fsc-api"
      type="text/javascript"
      data-storefront="simplify.test.onfastspring.com/popup-simplify"
      data-data-callback="dataCallbackFunction"
      data-popup-closed="onPopupClose"
      data-error-callback="errorCallback"
      data-popup-webhook-received="popupWebhookReceived"
      data-debug="false"
    ></script>
    <!-- Documentation: https://fastspring.com/docs/get-started-with-store-builder-library/
      data-before-requests-callback="beforeRequestsCallbackFunction"
      data-after-requests-callback="afterRequestsCallbackFunction"
      data-before-markup-callback="beforeMarkupCallbackFunction"
      data-after-markup-callback="afterMarkupCallbackFunction"
      data-decorate-callback="decorateURLFunction"
      data-popup-event-received="popupEventReceived"
      data-access-key=".. access key .."
      data-continuous="true"
    -->
    <style>
      body {
        padding: 100px;
        line-height: 1.7em;
        font-size: 16px;
      }
      li {
        padding-bottom: 0.7em;
      }
      .annual .monthly,
      .monthly .annual {
        display: none;
      }

      #simplify div {
        margin: 10px;
        padding: 5px 10px;
      }
      #simplify input {
        padding: 5px;
      }
      #simplify button {
        margin: 10px 20px;
        padding: 5px 10px;
      }
    </style>
  </head>
  <body>
    <div id="simplify">
      <b>Pricing v1.23</b> - In testing. Not for real use.

      <div id="plan" class="annual">
        <span class="annual"
          ><b>Annual</b> |
          <a href="#" onclick="togglePlan('monthly')">Monthly</a></span
        >
        <span class="monthly"
          ><a href="#" onclick="togglePlan('annual')">Annual</a> |
          <b>Monthly</b></span
        >
      </div>
      <div id="quantity">
        <input
          type="number"
          id="quantity-value"
          min="1"
          max="20"
          step="1"
          value="1"
        />
      </div>

      <button id="checkoutButton" onclick="checkout()">Checkout</button>
    </div>
  </body>

  <script>
    // UTILITIES
    const get = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelector(selector);
      } else {
        return parent.querySelector(selector);
      }
    };

    const gets = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelectorAll(selector);
      } else {
        return parent.querySelectorAll(selector);
      }
    };

    const count = (selector, parent = "") => {
      if (parent === "") {
        return document.querySelectorAll(selector).length;
      } else {
        return parent.querySelectorAll(selector).length;
      }
    };

    const fsUtil = {
      dataCallbackFunction(order) {
        console.log("[Simplify] Order data retrieved", order);
      },

      errorCallback(code, string) {
        console.log("Error from Fastspring: ", code, string);
      },
      onPopupClose(order) {
        if (order === null) {
          console.log("[Simplify] Popup closed: Order failed", order);
        } else {
          console.log("[Simplify] Popup closed: Order succeeded?", order);
        }
      },
      popupWebhookReceived(order) {
        console.log("[Simplify] Order received?", order);
      },
    };

    // FASTSPRING UTILS
    function dataCallbackFunction(order) {
      console.log("[Simplify] Order data retrieved", order);
    }
    function errorCallback(code, string) {
      console.log("[Simplify] Error: ", code, string);
    }
    function onPopupClose(order) {
      if (order === null) {
        console.log("[Simplify] Popup closed: Order failed", order);
        // updateCart();
      } else {
        console.log("[Simplify] Popup closed: Order succeeded?", order);
      }
    }
    function popupWebhookReceived(order) {
      console.log("[Simplify] Order received?", order);
    }

    // FASTSPRING CHECKOUT
    function togglePlan(newPlan) {
      let planEl = get("#plan");
      planEl.classList.remove("annual", "monthly");
      planEl.classList.add(newPlan);
    }

    function checkout(newPlan, checkout = false) {
      let qty = get("#quantity-value").value;
      let plan = get("#plan").className;

      let session = {
        products: [
          {
            path: `simplify-gmail-${plan}-${qty}`,
            quantity: 1,
          },
        ],
        paymentContact: {
          email: "hi.simplify@gmail.com",
          firstName: "Michael",
          lastName: "Leggett",
        },
        checkout: true,
      };
      fastspring.builder.push(session);
    }

    // CREATE VARIATIONS
    /*
    let lastNum = 2;
    let maxNum = 21;
    let plan = "annual";

    function showVariant() {
      if (lastNum >= maxNum) return;

      if (count('#dynamicDialog.in') === 0) {
        // Show variant for lastNum
        onSelectVariation(`simplify-gmail-${plan}-${lastNum}`, `simplify-gmail-${plan}-${lastNum}`);

        // Check price, has it been changed?
        let sel = `tr[data-dialog-title="Pricing"][data-dialog-link*="gmail-${plan}-${lastNum}"] .valueMoney`
        let price = get(sel)?.innerText
        if (price !== "$24.00 USD") lastNum += 1;
      }

      setTimeout(showVariant, 1000);
    }
    showVariant();
    */
  </script>
</html>
